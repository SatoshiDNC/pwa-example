/* esm.sh - esbuild bundle(@getalby/lightning-tools@5.0.3) es2022 production */
var K=class{constructor(e){this.storage=void 0,this.storage=e||{}}getItem(e){return this.storage[e]}setItem(e,o){this.storage[e]=o}},be={__proto__:null,MemoryStorage:K,NoStorage:class{constructor(s){}getItem(s){return null}setItem(s,e){}},default:K},ve=new K,re=async(s,e,o)=>{o||(o={});let i=o.headerKey||"L402",a=o.webln||globalThis.webln;if(!a)throw new Error("WebLN is missing");let c=o.store||ve;e||(e={}),e.cache="no-store",e.mode="cors",e.headers||(e.headers={});let u=c.getItem(s);if(u){let E=JSON.parse(u);return e.headers.Authorization=`${i} ${E.token}:${E.preimage}`,await fetch(s,e)}e.headers["Accept-Authenticate"]=i;let p=await fetch(s,e),b=p.headers.get("www-authenticate");if(!b)return p;let I=(E=>{let W=E.replace("L402","").replace("LSAT","").trim(),$={},U=/(\w+)=("([^"]*)"|'([^']*)'|([^,]*))/g,y;for(;(y=U.exec(W))!==null;)$[y[1]]=y[3]||y[4]||y[5];return $})(b),x=I.token||I.macaroon,D=I.invoice;await a.enable();let A=await a.sendPayment(D);return c.setItem(s,JSON.stringify({token:x,preimage:A.preimage})),e.headers.Authorization=`${i} ${x}:${A.preimage}`,await fetch(s,e)},Ie={__proto__:null,storage:be,fetchWithL402:re,default:re},Z=async(s,e)=>{let{boost:o}=s;e||(e={});let i=e.webln||globalThis.webln;if(!i)throw new Error("WebLN not available");if(!i.keysend)throw new Error("Keysend not available in current WebLN provider");let a=s.amount||Math.floor(o.value_msat/1e3),c={destination:s.destination,amount:a,customRecords:{7629169:JSON.stringify(o)}};return s.customKey&&s.customValue&&(c.customRecords[s.customKey]=s.customValue),await i.enable(),await i.keysend(c)},Ue={__proto__:null,boost:Z,default:Z};function G(){return G=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(s[i]=o[i])}return s},G.apply(this,arguments)}async function z(s){let e=typeof s=="string"?new TextEncoder().encode(s):s,o=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(o)).map(i=>i.toString(16).padStart(2,"0")).join("")}var Ee=/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=+$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=+$,\w]+@)[A-Za-z0-9.-]+)((?:\/[+~%/.\w-_]*)?\??(?:[-+=&;%@.\w_]*)#?(?:[\w]*))?)/,te=s=>!!s&&Ee.test(s),ne=({amount:s,min:e,max:o})=>s>0&&s>=e&&s<=o,oe,J,xe=(oe=function(s,e){function o(r){if(!Number.isSafeInteger(r))throw new Error(`Wrong integer: ${r}`)}function i(...r){let t=(n,l)=>h=>n(l(h));return{encode:Array.from(r).reverse().reduce((n,l)=>n?t(n,l.encode):l.encode,void 0),decode:r.reduce((n,l)=>n?t(n,l.decode):l.decode,void 0)}}function a(r){return{encode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return t.map(n=>{if(o(n),n<0||n>=r.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${r.length})`);return r[n]})},decode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("alphabet.decode input should be array of strings");return t.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);let l=r.indexOf(n);if(l===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${r}`);return l})}}}function c(r=""){if(typeof r!="string")throw new Error("join separator should be string");return{encode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("join.encode input should be array of strings");for(let n of t)if(typeof n!="string")throw new Error(`join.encode: non-string input=${n}`);return t.join(r)},decode:t=>{if(typeof t!="string")throw new Error("join.decode input should be string");return t.split(r)}}}function u(r,t="="){if(o(r),typeof t!="string")throw new Error("padding chr should be string");return{encode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let l of n)if(typeof l!="string")throw new Error(`padding.encode: non-string input=${l}`);for(;n.length*r%8;)n.push(t);return n},decode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let h of n)if(typeof h!="string")throw new Error(`padding.decode: non-string input=${h}`);let l=n.length;if(l*r%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;l>0&&n[l-1]===t;l--)if(!((l-1)*r%8))throw new Error("Invalid padding: string has too much padding");return n.slice(0,l)}}}function p(r){if(typeof r!="function")throw new Error("normalize fn should be function");return{encode:t=>t,decode:t=>r(t)}}function b(r,t,n){if(t<2)throw new Error(`convertRadix: wrong from=${t}, base cannot be less than 2`);if(n<2)throw new Error(`convertRadix: wrong to=${n}, base cannot be less than 2`);if(!Array.isArray(r))throw new Error("convertRadix: data should be array");if(!r.length)return[];let l=0,h=[],d=Array.from(r);for(d.forEach(f=>{if(o(f),f<0||f>=t)throw new Error(`Wrong integer: ${f}`)});;){let f=0,w=!0;for(let m=l;m<d.length;m++){let S=d[m],k=t*f+S;if(!Number.isSafeInteger(k)||t*f/t!==f||k-S!=t*f)throw new Error("convertRadix: carry overflow");if(f=k%n,d[m]=Math.floor(k/n),!Number.isSafeInteger(d[m])||d[m]*n+f!==k)throw new Error("convertRadix: carry overflow");w&&(d[m]?w=!1:l=m)}if(h.push(f),w)break}for(let f=0;f<r.length-1&&r[f]===0;f++)h.push(0);return h.reverse()}Object.defineProperty(e,"__esModule",{value:!0}),e.bytes=e.stringToBytes=e.str=e.bytesToString=e.hex=e.utf8=e.bech32m=e.bech32=e.base58check=e.base58xmr=e.base58xrp=e.base58flickr=e.base58=e.base64url=e.base64=e.base32crockford=e.base32hex=e.base32=e.base16=e.utils=e.assertNumber=void 0,e.assertNumber=o;let I=(r,t)=>t?I(t,r%t):r,x=(r,t)=>r+(t-I(r,t));function D(r,t,n,l){if(!Array.isArray(r))throw new Error("convertRadix2: data should be array");if(t<=0||t>32)throw new Error(`convertRadix2: wrong from=${t}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(x(t,n)>32)throw new Error(`convertRadix2: carry overflow from=${t} to=${n} carryBits=${x(t,n)}`);let h=0,d=0,f=2**n-1,w=[];for(let m of r){if(o(m),m>=2**t)throw new Error(`convertRadix2: invalid data word=${m} from=${t}`);if(h=h<<t|m,d+t>32)throw new Error(`convertRadix2: carry overflow pos=${d} from=${t}`);for(d+=t;d>=n;d-=n)w.push((h>>d-n&f)>>>0);h&=2**d-1}if(h=h<<n-d&f,!l&&d>=t)throw new Error("Excess padding");if(!l&&h)throw new Error(`Non-zero padding: ${h}`);return l&&d>0&&w.push(h>>>0),w}function A(r){return o(r),{encode:t=>{if(!(t instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return b(Array.from(t),256,r)},decode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(b(t,r,256))}}}function E(r,t=!1){if(o(r),r<=0||r>32)throw new Error("radix2: bits should be in (0..32]");if(x(8,r)>32||x(r,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!(n instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return D(Array.from(n),8,r,!t)},decode:n=>{if(!Array.isArray(n)||n.length&&typeof n[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(D(n,r,8,t))}}}function W(r){if(typeof r!="function")throw new Error("unsafeWrapper fn should be function");return function(...t){try{return r.apply(null,t)}catch{}}}function $(r,t){if(o(r),typeof t!="function")throw new Error("checksum fn should be function");return{encode(n){if(!(n instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");let l=t(n).slice(0,r),h=new Uint8Array(n.length+r);return h.set(n),h.set(l,n.length),h},decode(n){if(!(n instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");let l=n.slice(0,-r),h=t(l).slice(0,r),d=n.slice(-r);for(let f=0;f<r;f++)if(h[f]!==d[f])throw new Error("Invalid checksum");return l}}}e.utils={alphabet:a,chain:i,checksum:$,radix:A,radix2:E,join:c,padding:u},e.base16=i(E(4),a("0123456789ABCDEF"),c("")),e.base32=i(E(5),a("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),u(5),c("")),e.base32hex=i(E(5),a("0123456789ABCDEFGHIJKLMNOPQRSTUV"),u(5),c("")),e.base32crockford=i(E(5),a("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),c(""),p(r=>r.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),e.base64=i(E(6),a("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),u(6),c("")),e.base64url=i(E(6),a("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),u(6),c(""));let U=r=>i(A(58),a(r),c(""));e.base58=U("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),e.base58flickr=U("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),e.base58xrp=U("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");let y=[0,2,3,5,6,7,9,10,11];e.base58xmr={encode(r){let t="";for(let n=0;n<r.length;n+=8){let l=r.subarray(n,n+8);t+=e.base58.encode(l).padStart(y[l.length],"1")}return t},decode(r){let t=[];for(let n=0;n<r.length;n+=11){let l=r.slice(n,n+11),h=y.indexOf(l.length),d=e.base58.decode(l);for(let f=0;f<d.length-h;f++)if(d[f]!==0)throw new Error("base58xmr: wrong padding");t=t.concat(Array.from(d.slice(d.length-h)))}return Uint8Array.from(t)}},e.base58check=r=>i($(4,t=>r(r(t))),e.base58);let B=i(a("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),c("")),N=[996825010,642813549,513874426,1027748829,705979059];function T(r){let t=r>>25,n=(33554431&r)<<5;for(let l=0;l<N.length;l++)(t>>l&1)==1&&(n^=N[l]);return n}function O(r,t,n=1){let l=r.length,h=1;for(let d=0;d<l;d++){let f=r.charCodeAt(d);if(f<33||f>126)throw new Error(`Invalid prefix (${r})`);h=T(h)^f>>5}h=T(h);for(let d=0;d<l;d++)h=T(h)^31&r.charCodeAt(d);for(let d of t)h=T(h)^d;for(let d=0;d<6;d++)h=T(h);return h^=n,B.encode(D([h%2**30],30,5,!1))}function v(r){let t=r==="bech32"?1:734539939,n=E(5),l=n.decode,h=n.encode,d=W(l);function f(w,m=90){if(typeof w!="string")throw new Error("bech32.decode input should be string, not "+typeof w);if(w.length<8||m!==!1&&w.length>m)throw new TypeError(`Wrong string length: ${w.length} (${w}). Expected (8..${m})`);let S=w.toLowerCase();if(w!==S&&w!==w.toUpperCase())throw new Error("String must be lowercase or uppercase");let k=(w=S).lastIndexOf("1");if(k===0||k===-1)throw new Error('Letter "1" must be present between prefix and data only');let H=w.slice(0,k),g=w.slice(k+1);if(g.length<6)throw new Error("Data must be at least 6 characters long");let j=B.decode(g).slice(0,-6),P=O(H,j,t);if(!g.endsWith(P))throw new Error(`Invalid checksum in ${w}: expected "${P}"`);return{prefix:H,words:j}}return{encode:function(w,m,S=90){if(typeof w!="string")throw new Error("bech32.encode prefix should be string, not "+typeof w);if(!Array.isArray(m)||m.length&&typeof m[0]!="number")throw new Error("bech32.encode words should be array of numbers, not "+typeof m);let k=w.length+7+m.length;if(S!==!1&&k>S)throw new TypeError(`Length ${k} exceeds limit ${S}`);return`${w=w.toLowerCase()}1${B.encode(m)}${O(w,m,t)}`},decode:f,decodeToBytes:function(w){let{prefix:m,words:S}=f(w,!1);return{prefix:m,words:S,bytes:l(S)}},decodeUnsafe:W(f),fromWords:l,fromWordsUnsafe:d,toWords:h}}e.bech32=v("bech32"),e.bech32m=v("bech32m"),e.utf8={encode:r=>new TextDecoder().decode(r),decode:r=>new TextEncoder().encode(r)},e.hex=i(E(4),a("0123456789abcdef"),c(""),p(r=>{if(typeof r!="string"||r.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof r} with length ${r.length}`);return r.toLowerCase()}));let _={utf8:e.utf8,hex:e.hex,base16:e.base16,base32:e.base32,base64:e.base64,base64url:e.base64url,base58:e.base58,base58xmr:e.base58xmr},q=`Invalid encoding type. Available types: ${Object.keys(_).join(", ")}`;e.bytesToString=(r,t)=>{if(typeof r!="string"||!_.hasOwnProperty(r))throw new TypeError(q);if(!(t instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return _[r].encode(t)},e.str=e.bytesToString,e.stringToBytes=(r,t)=>{if(!_.hasOwnProperty(r))throw new TypeError(q);if(typeof t!="string")throw new TypeError("stringToBytes() expects string");return _[r].decode(t)},e.bytes=e.stringToBytes},oe(J={exports:{}},J.exports),J.exports),{bech32:L,hex:R,utf8:_e}=xe,se={bech32:"bc",pubKeyHash:0,scriptHash:5,validWitnessVersions:[0]},ae={bech32:"tb",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},ie={bech32:"tbs",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},ce={bech32:"bcrt",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},le={bech32:"sb",pubKeyHash:63,scriptHash:123,validWitnessVersions:[0]},V=["option_data_loss_protect","initial_routing_sync","option_upfront_shutdown_script","gossip_queries","var_onion_optin","gossip_queries_ex","option_static_remotekey","payment_secret","basic_mpp","option_support_large_channel"],ke={m:BigInt(1e3),u:BigInt(1e6),n:BigInt(1e9),p:BigInt(1e12)},Ae=BigInt("2100000000000000000"),he=BigInt(1e11),X={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27},fe={};for(let s=0,e=Object.keys(X);s<e.length;s++){let o=e[s],i=X[e[s]].toString();fe[i]=o}var $e={1:s=>R.encode(L.fromWordsUnsafe(s)),16:s=>R.encode(L.fromWordsUnsafe(s)),13:s=>_e.encode(L.fromWordsUnsafe(s)),19:s=>R.encode(L.fromWordsUnsafe(s)),23:s=>R.encode(L.fromWordsUnsafe(s)),27:s=>R.encode(L.fromWordsUnsafe(s)),6:M,24:M,3:function(s){let e=[],o,i,a,c,u,p=L.fromWordsUnsafe(s);for(;p.length>0;)o=R.encode(p.slice(0,33)),i=R.encode(p.slice(33,41)),a=parseInt(R.encode(p.slice(41,45)),16),c=parseInt(R.encode(p.slice(45,49)),16),u=parseInt(R.encode(p.slice(49,51)),16),p=p.slice(51),e.push({pubkey:o,short_channel_id:i,fee_base_msat:a,fee_proportional_millionths:c,cltv_expiry_delta:u});return e},5:function(s){let e=s.slice().reverse().map(a=>[!!(1&a),!!(2&a),!!(4&a),!!(8&a),!!(16&a)]).reduce((a,c)=>a.concat(c),[]);for(;e.length<2*V.length;)e.push(!1);let o={};V.forEach((a,c)=>{let u;u=e[2*c]?"required":e[2*c+1]?"supported":"unsupported",o[a]=u});let i=e.slice(2*V.length);return o.extra_bits={start_bit:2*V.length,bits:i,has_required:i.reduce((a,c,u)=>u%2!=0?a||!1:a||c,!1)},o}};function Ne(s){return e=>({tagCode:parseInt(s),words:L.encode("unknown",e,Number.MAX_SAFE_INTEGER)})}function M(s){return s.reverse().reduce((e,o,i)=>e+o*Math.pow(32,i),0)}var Q=class{constructor(e){var o,i,a;if(this.paymentRequest=void 0,this.paymentHash=void 0,this.preimage=void 0,this.verify=void 0,this.satoshi=void 0,this.expiry=void 0,this.timestamp=void 0,this.createdDate=void 0,this.expiryDate=void 0,this.description=void 0,this.paymentRequest=e.pr,!this.paymentRequest)throw new Error("Invalid payment request");let c=(u=>{if(!u)return null;try{let p=function(y,B){if(typeof y!="string")throw new Error("Lightning Payment Request must be string");if(y.slice(0,2).toLowerCase()!=="ln")throw new Error("Not a proper lightning payment request");let N=[],T=L.decode(y,Number.MAX_SAFE_INTEGER);y=y.toLowerCase();let O=T.prefix,v=T.words,_=y.slice(O.length+1),q=v.slice(-104);v=v.slice(0,-104);let r=O.match(/^ln(\S+?)(\d*)([a-zA-Z]?)$/);if(r&&!r[2]&&(r=O.match(/^ln(\S+)$/)),!r)throw new Error("Not a proper lightning payment request");N.push({name:"lightning_network",letters:"ln"});let t=r[1],n;switch(t){case se.bech32:n=se;break;case ae.bech32:n=ae;break;case ie.bech32:n=ie;break;case ce.bech32:n=ce;break;case le.bech32:n=le}if(!n||n.bech32!==t)throw new Error("Unknown coin bech32 prefix");N.push({name:"coin_network",letters:t,value:n});let l=r[2],h;l?(h=function(g,j){let P,C;if(g.slice(-1).match(/^[munp]$/))P=g.slice(-1),C=g.slice(0,-1);else{if(g.slice(-1).match(/^[^munp0-9]$/))throw new Error("Not a valid multiplier for the amount");C=g}if(!C.match(/^\d+$/))throw new Error("Not a valid human readable amount");let F=BigInt(C),ee=P?F*he/ke[P]:F*he;if(P==="p"&&F%BigInt(10)!==BigInt(0)||ee>Ae)throw new Error("Amount is outside of valid range");return ee.toString()}(l+r[3]),N.push({name:"amount",letters:r[2]+r[3],value:h})):h=null,N.push({name:"separator",letters:"1"});let d=M(v.slice(0,7)),f,w,m,S;for(v=v.slice(7),N.push({name:"timestamp",letters:_.slice(0,7),value:d}),_=_.slice(7);v.length>0;){let g=v[0].toString();f=fe[g]||"unknown_tag",w=$e[g]||Ne(g),v=v.slice(1),m=M(v.slice(0,2)),v=v.slice(2),S=v.slice(0,m),v=v.slice(m),N.push({name:f,tag:_[0],letters:_.slice(0,3+m),value:w(S)}),_=_.slice(3+m)}N.push({name:"signature",letters:_.slice(0,104),value:R.encode(L.fromWordsUnsafe(q))}),_=_.slice(104),N.push({name:"checksum",letters:_});let k={paymentRequest:y,sections:N,get expiry(){let g=N.find(j=>j.name==="expiry");if(g)return H("timestamp")+g.value},get route_hints(){return N.filter(g=>g.name==="route_hint").map(g=>g.value)}};for(let g in X)g!=="route_hint"&&Object.defineProperty(k,g,{get:()=>H(g)});return k;function H(g){let j=N.find(P=>P.name===g);return j?j.value:void 0}}(u);if(!p||!p.sections)return null;let b=p.sections.find(y=>y.name==="payment_hash");if(b?.name!=="payment_hash"||!b.value)return null;let I=b.value,x=p.sections.find(y=>y.name==="amount");if(x?.name!=="amount"||x.value===void 0)return null;let D=parseInt(x.value)/1e3,A=p.sections.find(y=>y.name==="timestamp");if(A?.name!=="timestamp"||!A.value)return null;let E=A.value,W,$=p.sections.find(y=>y.name==="expiry");$?.name==="expiry"&&(W=$.value);let U=p.sections.find(y=>y.name==="description");return{paymentHash:I,satoshi:D,timestamp:E,expiry:W,description:U?.name==="description"?U?.value:void 0}}catch{return null}})(this.paymentRequest);if(!c)throw new Error("Failed to decode payment request");this.paymentHash=c.paymentHash,this.satoshi=c.satoshi,this.timestamp=c.timestamp,this.expiry=c.expiry,this.createdDate=new Date(1e3*this.timestamp),this.expiryDate=this.expiry?new Date(1e3*(this.timestamp+this.expiry)):void 0,this.description=(o=c.description)!=null?o:null,this.verify=(i=e.verify)!=null?i:null,this.preimage=(a=e.preimage)!=null?a:null}async isPaid(){if(this.preimage)return this.validatePreimage(this.preimage);if(this.verify)return await this.verifyPayment();throw new Error("Could not verify payment")}async validatePreimage(e){if(!e||!this.paymentHash)return!1;try{let i=await z((o=e,Uint8Array.from(o.match(/.{1,2}/g).map(a=>parseInt(a,16)))));return this.paymentHash===i}catch{return!1}var o}async verifyPayment(){if(!this.verify)throw new Error("LNURL verify not available");let e=await fetch(this.verify),o=await e.json();return o.preimage&&(this.preimage=o.preimage),o.settled}};async function pe({satoshi:s,comment:e,p:o,e:i,relays:a},c={}){let u=c.nostr||globalThis.nostr;if(!u)throw new Error("nostr option or window.nostr is not available");let p=[["relays",...a],["amount",s.toString()]];o&&p.push(["p",o]),i&&p.push(["e",i]);let b={pubkey:await u.getPublicKey(),created_at:Math.floor(Date.now()/1e3),kind:9734,tags:p,content:e??""};return b.id=await ye(b),await u.signEvent(b)}function we(s){if(typeof s.content!="string"||typeof s.created_at!="number"||!Array.isArray(s.tags))return!1;for(let e=0;e<s.tags.length;e++){let o=s.tags[e];if(!Array.isArray(o))return!1;for(let i=0;i<o.length;i++)if(typeof o[i]=="object")return!1}return!0}function me(s){if(!we(s))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,s.pubkey,s.created_at,s.kind,s.tags,s.content])}function ye(s){return z(me(s))}function ge(s,e){let o,i;var a,c;return e&&s&&(o=(a=s.names)==null?void 0:a[e],i=o?(c=s.relays)==null?void 0:c[o]:void 0),[s,o,i]}var De={__proto__:null,generateZapEvent:pe,validateEvent:we,serializeEvent:me,getEventHash:ye,parseNostrResponse:ge},Se=/^((?:[^<>()[\]\\.,;:\s@"]+(?:\.[^<>()[\]\\.,;:\s@"]+)*)|(?:".+"))@((?:\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(?:(?:[a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,ue=class{constructor(e,o){this.address=void 0,this.options=void 0,this.username=void 0,this.domain=void 0,this.pubkey=void 0,this.lnurlpData=void 0,this.keysendData=void 0,this.nostrData=void 0,this.nostrPubkey=void 0,this.nostrRelays=void 0,this.webln=void 0,this.address=e,this.options={proxy:"https://api.getalby.com/lnurl"},this.options=Object.assign(this.options,o),this.parse(),this.webln=this.options.webln}parse(){let e=Se.exec(this.address.toLowerCase());e&&(this.username=e[1],this.domain=e[2])}getWebLN(){return this.webln||globalThis.webln}async fetch(){return this.options.proxy?this.fetchWithProxy():this.fetchWithoutProxy()}async fetchWithProxy(){let e=await fetch(`${this.options.proxy}/lightning-address-details?${new URLSearchParams({ln:this.address}).toString()}`),o=await e.json();await this.parseResponse(o.lnurlp,o.keysend,o.nostr)}async fetchWithoutProxy(){if(!this.domain||!this.username)return;let e=await fetch(this.lnurlpUrl()),o=await fetch(this.keysendUrl()),i=await fetch(this.nostrUrl()),a,c,u;e.ok&&(a=await e.json()),o.ok&&(c=await o.json()),i.ok&&(u=await i.json()),await this.parseResponse(a,c,u)}lnurlpUrl(){return`https://${this.domain}/.well-known/lnurlp/${this.username}`}keysendUrl(){return`https://${this.domain}/.well-known/keysend/${this.username}`}nostrUrl(){return`https://${this.domain}/.well-known/nostr.json?name=${this.username}`}async generateInvoice(e){let o;if(this.options.proxy)o=(await(await fetch(`${this.options.proxy}/generate-invoice?${new URLSearchParams(G({ln:this.address},e)).toString()}`)).json()).invoice;else{if(!this.lnurlpData)throw new Error("No lnurlpData available. Please call fetch() first.");if(!this.lnurlpData.callback||!te(this.lnurlpData.callback))throw new Error("Valid callback does not exist in lnurlpData");let c=new URL(this.lnurlpData.callback);c.search=new URLSearchParams(e).toString(),o=await(await fetch(c.toString())).json()}let i=o&&o.pr&&o.pr.toString();if(!i)throw new Error("Invalid pay service invoice");let a={pr:i};return o&&o.verify&&(a.verify=o.verify.toString()),new Q(a)}async requestInvoice(e){if(!this.lnurlpData)throw new Error("No lnurlpData available. Please call fetch() first.");let o=1e3*e.satoshi,{commentAllowed:i,min:a,max:c}=this.lnurlpData;if(!ne({amount:o,min:a,max:c}))throw new Error("Invalid amount");if(e.comment&&i&&i>0&&e.comment.length>i)throw new Error(`The comment length must be ${i} characters or fewer`);let u={amount:o.toString()};return e.comment&&(u.comment=e.comment),e.payerdata&&(u.payerdata=JSON.stringify(e.payerdata)),this.generateInvoice(u)}async boost(e,o=0){if(!this.keysendData)throw new Error("No keysendData available. Please call fetch() first.");let{destination:i,customKey:a,customValue:c}=this.keysendData,u=this.getWebLN();if(!u)throw new Error("WebLN not available");return Z({destination:i,customKey:a,customValue:c,amount:o,boost:e},{webln:u})}async zapInvoice({satoshi:e,comment:o,relays:i,e:a},c={}){if(!this.lnurlpData)throw new Error("No lnurlpData available. Please call fetch() first.");if(!this.nostrPubkey)throw new Error("Nostr Pubkey is missing");let u=this.nostrPubkey,p=1e3*e,{allowsNostr:b,min:I,max:x}=this.lnurlpData;if(!ne({amount:p,min:I,max:x}))throw new Error("Invalid amount");if(!b)throw new Error("Your provider does not support zaps");let D=await pe({satoshi:p,comment:o,p:u,e:a,relays:i},c),A={amount:p.toString(),nostr:JSON.stringify(D)};return await this.generateInvoice(A)}async zap(e,o={}){let i=this.zapInvoice(e,o),a=this.getWebLN();if(!a)throw new Error("WebLN not available");return await a.enable(),a.sendPayment((await i).paymentRequest)}async parseResponse(e,o,i){e&&(this.lnurlpData=await(async a=>{if(a.tag!=="payRequest")throw new Error("Invalid pay service params");let c=(a.callback+"").trim();if(!te(c))throw new Error("Callback must be a valid url");let u=Math.ceil(Number(a.minSendable||0)),p=Math.floor(Number(a.maxSendable));if(!u||!p||u>p)throw new Error("Invalid pay service params");let b,I;try{b=JSON.parse(a.metadata+""),I=await z(a.metadata+"")}catch{b=[],I=await z("[]")}let x="",D="",A="";for(let $=0;$<b.length;$++){let[U,y]=b[$];switch(U){case"text/plain":D=y;break;case"text/identifier":A=y;break;case"image/png;base64":case"image/jpeg;base64":x="data:"+U+","+y}}let E=a.payerData,W;try{W=new URL(c).hostname}catch{}return{callback:c,fixed:u===p,min:u,max:p,domain:W,metadata:b,metadataHash:I,identifier:A,description:D,image:x,payerData:E,commentAllowed:Number(a.commentAllowed)||0,rawData:a,allowsNostr:a.allowsNostr||!1}})(e)),o&&(this.keysendData=(a=>{if(a.tag!=="keysend")throw new Error("Invalid keysend params");if(a.status!=="OK")throw new Error("Keysend status not OK");if(!a.pubkey)throw new Error("Pubkey does not exist");let c,u;return a.customData&&a.customData[0]&&(c=a.customData[0].customKey,u=a.customData[0].customValue),{destination:a.pubkey,customKey:c,customValue:u}})(o)),i&&([this.nostrData,this.nostrPubkey,this.nostrRelays]=ge(i,this.username))}},Y=async s=>{let e="https://getalby.com/api/rates/"+s.toLowerCase()+".json";return(await(await fetch(e)).json()).rate_float/1e8},de=async({satoshi:s,currency:e})=>{let o=await Y(e);return Number(s)*o},Re={__proto__:null,getFiatBtcRate:Y,getFiatValue:de,getSatoshiValue:async({amount:s,currency:e})=>{let o=await Y(e);return Math.floor(Number(s)/o)},getFormattedFiatValue:async({satoshi:s,currency:e,locale:o})=>(o||(o="en"),(await de({satoshi:s,currency:e})).toLocaleString(o,{style:"currency",currency:e}))};export{Q as Invoice,ue as LightningAddress,Ue as boostagrams,re as fetchWithL402,Re as fiat,Ie as l402,De as nostr,Z as sendBoostagram};
//# sourceMappingURL=lightning-tools.mjs.map